upstream list-cdn-ins {
    server [2a03:2880:f20c:c4:face:b00c:0:43fe]:443 max_fails=10 fail_timeout=60s;
    server [2a03:2880:f20c:e5:face:b00c:0:4420]:443 max_fails=10 fail_timeout=60s;
    server [2a03:2880:f20c:ea:face:b00c:0:6200]:443 max_fails=10 fail_timeout=60s;
    server [2a03:2880:f20c:1ca:face:b00c:0:43fe]:443 max_fails=10 fail_timeout=60s;
    server [2a03:2880:f20c:1e5:face:b00c:0:4420]:443 max_fails=10 fail_timeout=60s;
    server [2a03:2880:f20c:1ea:face:b00c:0:6200]:443 max_fails=10 fail_timeout=60s;
    server [2a03:2880:f20c:2c4:face:b00c:0:43fe]:443 max_fails=10 fail_timeout=60s;
    server [2a03:2880:f20c:2e5:face:b00c:0:4420]:443 max_fails=10 fail_timeout=60s;
    server [2a03:2880:f20c:2ea:face:b00c:0:6200]:443 max_fails=10 fail_timeout=60s;
    server [2a03:2880:f20c:3c2:face:b00c:0:43fe]:443 max_fails=10 fail_timeout=60s;
    server [2a03:2880:f20c:3e6:face:b00c:0:4420]:443 max_fails=10 fail_timeout=60s;
    server [2a03:2880:f20c:3ea:face:b00c:0:6200]:443 max_fails=10 fail_timeout=60s;
    server [2a03:2880:f215:c3:face:b00c:0:43fe]:443 max_fails=10 fail_timeout=60s;
    server [2a03:2880:f215:e3:face:b00c:0:6200]:443 max_fails=10 fail_timeout=60s;
    server [2a03:2880:f215:e8:face:b00c:0:4420]:443 max_fails=10 fail_timeout=60s;
    server [2a03:2880:f215:1d2:face:b00c:0:43fe]:443 max_fails=10 fail_timeout=60s;
    server [2a03:2880:f215:1e0:face:b00c:0:4420]:443 max_fails=10 fail_timeout=60s;
    server [2a03:2880:f215:1e7:face:b00c:0:6200]:443 max_fails=10 fail_timeout=60s;
    server [2a03:2880:f24e:cb:face:b00c:0:43fe]:443 max_fails=10 fail_timeout=60s;
    server [2a03:2880:f24e:e0:face:b00c:0:4420]:443 max_fails=10 fail_timeout=60s;
    server [2a03:2880:f24e:ea:face:b00c:0:6200]:443 max_fails=10 fail_timeout=60s;
    server [2a03:2880:f25c:cc:face:b00c:0:43fe]:443 max_fails=10 fail_timeout=60s;
    server [2a03:2880:f25c:e0:face:b00c:0:4420]:443 max_fails=10 fail_timeout=60s;
    server [2a03:2880:f25c:ea:face:b00c:0:6200]:443 max_fails=10 fail_timeout=60s;
    server [2a03:2880:f25c:1cc:face:b00c:0:43fe]:443 max_fails=10 fail_timeout=60s;
    server [2a03:2880:f25c:1e0:face:b00c:0:4420]:443 max_fails=10 fail_timeout=60s;
    server [2a03:2880:f25c:1ea:face:b00c:0:6200]:443 max_fails=10 fail_timeout=60s;
    server [2a03:2880:f25c:2c7:face:b00c:0:43fe]:443 max_fails=10 fail_timeout=60s;
    server [2a03:2880:f25c:2e3:face:b00c:0:4420]:443 max_fails=10 fail_timeout=60s;
    server [2a03:2880:f25c:2ea:face:b00c:0:6200]:443 max_fails=10 fail_timeout=60s;
    server [2a03:2880:f25e:ca:face:b00c:0:43fe]:443 max_fails=10 fail_timeout=60s;
    server [2a03:2880:f25e:e0:face:b00c:0:4420]:443 max_fails=10 fail_timeout=60s;
    server [2a03:2880:f25e:ea:face:b00c:0:6200]:443 max_fails=10 fail_timeout=60s;
    server [2a03:2880:f25e:1ca:face:b00c:0:43fe]:443 max_fails=10 fail_timeout=60s;
    server [2a03:2880:f25e:1e4:face:b00c:0:4420]:443 max_fails=10 fail_timeout=60s;
    server [2a03:2880:f25e:1ea:face:b00c:0:6200]:443 max_fails=10 fail_timeout=60s;
    keepalive 16;
    keepalive_time 1h;
    keepalive_timeout 300s;
    keepalive_requests 10000;
}

server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name edge-chat.instagram.com;

    #access_log logs/Instagram-access.log main buffer=4k;
    access_log off;
    error_log logs/Instagram-error.log;

    include cert.conf;
    location / {
        proxy_pass https://list-cdn-ins/;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        include Proxy.params;
    }
}

upstream ins-gateway {
    server [2a03:2880:f05c:1:face:b00c:0:6206]:443;
    server [2a03:2880:f05c:100:face:b00c:0:6206]:443;
    server [2a03:2880:f05c:208:face:b00c:0:6206]:443;
    server [2a03:2880:f05e:0:face:b00c:0:6206]:443;
    server [2a03:2880:f05e:115:face:b00c:0:6206]:443;
    server [2a03:2880:f0a2:13:face:b00c:0:6206]:443;
    server [2a03:2880:f00c:11:face:b00c:0:6206]:443;
    server [2a03:2880:f00c:108:face:b00c:0:6206]:443;
    server [2a03:2880:f00c:20c:face:b00c:0:6206]:443;
    server [2a03:2880:f00c:314:face:b00c:0:6206]:443;
    server [2a03:2880:f01d:d:face:b00c:0:6206]:443;
    server [2a03:2880:f01d:105:face:b00c:0:6206]:443;
    server [2a03:2880:f04e:1:face:b00c:0:6206]:443;
    keepalive 16;
}
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name gateway.instagram.com;

    #access_log logs/Instagram-access.log main buffer=4k;
    access_log off;
    error_log logs/Instagram-error.log;

    include cert.conf;
    location / {
        proxy_pass https://ins-gateway/;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        include Proxy.params;
    }
}
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name *.cdninstagram.com;

    server_name ig.me;
    server_name *.ig.me;
    server_name instagr.am;
    server_name *.instagr.am;
    server_name Instagram.com;
    server_name *.Instagram.com;

    #access_log logs/Instagram-access.log main buffer=4k;
    access_log off;
    error_log logs/Instagram-error.log;

    include cert.conf;
    location / {
        proxy_pass https://list-cdn-ins/;
        proxy_next_upstream error timeout http_429 http_500 http_502 http_503 http_504 non_idempotent;
        proxy_buffer_size 128k;
        proxy_buffers 16 32k;
        proxy_busy_buffers_size 128k;
        include Proxy.conf;
    }
}